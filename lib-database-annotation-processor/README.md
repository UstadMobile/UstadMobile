# Data Access Object (DAO) Annotation Processor

The annotation processor is designed to automate the creation of room persistence
style Data Access Objects (DAOs) and database classes for use on different platforms
(including Android via the Room Persistence Framework, JDBC, and GWT).

## Using the annotation processor
Put shared database and DAO classes in any Java module. Then setup the
gradle build files as required. The annotation processor has the following
options:
* umdb_room_out : the source directory to put generated room persistence
framework for Android. If using only a single implementation with a single
module, this can be "filer" to save output to the annotation processor
default directory.
* umdb_jdbc_out : the source directory to put generated JDBC output in.
If using only a single implementation with a single
module, this can be "filer" to save output to the annotation processor
default directory.
* umdb_no_default_factory : if present and set to true (default false),
no default factory implementation will be generated. This is needed in
the case of using a single module with only one implementation.

In the core module containing databases and DAOs:
```
compileJava {
    options.compilerArgs += [
        "-Aumdb_room_out=" + rootProject.file("android-module-name/build/generated/source/umdbprocessor").getAbsolutePath(),
        "-Aumdb_jdbc_out=" + rootProject.file("javase-module-name/build/generated/source/umdbprocessor").getAbsolutePath(),
        "-Aumdb_no_default_factory=false"
    ]
}

jar {
    exclude("db/class/package/*_Factory.*")
}


```

In the modules using generated implementations:

```
sourceSets {
    main.java.srcDirs += ["build/generated/source/umdbprocessor"]
}
```

## JDBC Testing

The generated JDBC implementation uses the standard JNDI/Datasource lookup
process. For testing purposes, we use simple-jndi. Any modules using the
JDBC implementation must provide a JNDI datasource. This can be done by
including simple-jndi. Jndi.properties must be in the resources path of
the module, and this should contain a datasource (this is done using
the jndi-config directory for tests).

## Implementation of realtime update notifications:

Door supports immediate client to server and server to client notifications of changes. This is done
as follows.

### Server to client:

1. The SyncableEntity must be annotated with a notifyOnUpdate query that returns a list of device
ids that will be notified (and uses the ChangeLog table to determine which entities were changed).

```
@SyncableEntity(tableId = TABLE_ID,
    notifyOnUpdate = """SELECT DISTINCT deviceId
                            FROM AccessGrant
                            WHERE entityUid IN (SELECT chEntityPk FROM ChangeLog WHERE chTableId = 42 AND CAST(dispatched AS BOOLEAN) = false)
                            AND tableId = 42""")
```

2. The generated create table SQL will add a trigger that will insert into the ChangeLog table
(which contains the entity primary key and the table id)

3. The ChangeLogMonitor (added using dependency injection on the server side) will receive the
onTablesChanged event and collect a list of tables changed. It will wait 100ms to collect any further
changes (so that UpdateNotifications are batched, thus reducing the workload), and it will then call
repo.dispatchUpdateNotifications once for each table on which any change has occurred. It uses a
coroutine fan-out to call repo.dispatchUpdateNotifications so this can be done concurrently.

4. The generated repo.dispatchUpdateNotifications will use generated code that uses the
notifyOnUpdateQuery from the @SyncableEntity annotation. This will insert entities into the
UpdateNotification table. It will also notify the UpdateNotificationManager singleton which will
dispatch this notification live to any client that is listening.


## Debugging the annotation processor using IntelliJ

### Using kapt

```
./gradlew -Dkotlin.daemon.jvm.options="-Xdebug,-Xrunjdwp:transport=dt_socket\,address=5006\,server=y\,suspend=n" lib-database-annotation-processor:clean lib-database-annotation-processor:test
```

In IntelliJ select Run, Debug..., Add a remote configuration, and 
enter the por as per org.gradle.jvmargs (e.g. 5006)

### Running tests

```
./gradlew lib-database-annotation-processor:jvmTest
```

## Known Issues

The JDBC implementation of list insert may not return all autogenerated primary keys, 
due the underlying implementation of getGeneratedKeys.

